# Lesson 3: Display highest selling photographers and merchants
Goal: Create a publicly accessible, unauthenticated RESTful API to query for the winners.

### Step 1: In your cloned repo, go to the winner-api directory

### Step 2: View the serverless.yml you find there
You can see that there is an API Gateway, a couple of API functions (scores and contributions), and a few roles that are deployed here.

This yaml deploys the public RESTful endpoint that allows you to GET the winners from the web service.  If desired, you could require authentication in a variety of different ways.  For this workshop we'll be using an unauthenticated endpoint here.  Also if desired, an auto-generated SDK can be created for this endpoint in a variety of different languages and swagger can be auto-generated.  Caching can be enabled, as well as thresholds and a variety of other features.

More details can be found here: https://serverless.com/framework/docs/providers/aws/events/apigateway/

### Step 3: Install the node modules and then deploy these components
From the winner-api directory
```sh
$ npm install
$ serverless deploy -s $STAGE
```

### Step 4: confirm that the AWS API Gateway deployed
* Look in the AWS console under AWS API Gateway.
* Copy the URL you find there under Stages.  That is the root of your endpoint.
* Go to that URL in your browser with the following paths.

Here's an example of what the URL looks like for an API Gateway endpoint:

```
https://zzzzzzzzzz.execute-apic.us-west-2.amazonaws.com/XXXX
```

Where `zzzzzzzzzzzz` is generated by AWS and `XXXX` will be the name of the stage, and the

```sh
wget -qO- https://iytaw7zggd.execute-api.us-west-2.amazonaws.com/a09y/scores?role=creator&limit=2 | more
```
The limit query parameter is optional.  The default is one result when limit is not passed.
```sh
/contributions
```
The contributions request returns the product ids that have contributions.  As an exercise, alter the winnerApi.js code to also return the lastSequenceNumber as well as the productId, then re-deploy.
```sh
$ serverless deploy function -f contributions -s $STAGE
```

Note that this gateway can scale massively.  To handle a lot more traffic (thousands of TPS) you'd want to ensure that your available AWS account limits could handle the traffic and increase the read IOPs on the DynamoDB table.

You should expect about a 50ms P50 and 130ms P99 from this endpoint under any scale.  The results here will be accurate within about a second of the purchase activity from a customer on the core stream.


---------------------------------------------------------------------------------------------------------------------

### Using AWS-CLI and JQ

#### AWS-CLI

If not already installed, easiest way to get it is via NPM [AWS-CLI on NPM](https://www.npmjs.com/package/aws-cli).
The AWS-CLI is a tremendously capable tool with which to interface with all the AWS services, but is beyond the scope of this project.

Having set up your `~/.aws/credentials` file for Serverless.com, the AWS-CLI will use that same identity file.
Use the `AWS_PROFILE` environment variable to select the profile to use when calling the AWS managed services.

#### JQ

Used to query and reshape JSON data in the shell, [JQ](https://stedolan.github.io/jq/download/) is used to parse the REST services and pull the info we need out of the responses.
In-depth examination of this tools is also beyond the scope of this workshop, but is useful for querying the JSON data we get back from AWS-CLI queries and our REST endpoints.

#### Query AWS for your API Gateway ID

This command combines the AWS-CLI tools and JQ to get the ID of the API we just deployed above.

```sh
export APIID=`aws apigateway get-rest-apis --region us-west-2 | jq '.items[] | select(.name | startswith("${STAGE}")) | .id' | sed 's/"//g'`
echo $APIID
```

#### Use WGET to query your Winner API

Now that we've got the Amazon assigned ID of our winner-api we can query it:

```sh
wget -qO- "https://${APIID}.execute-api.us-west-2.amazonaws.com/${STAGE}/scores?role=creator&limit=2" | more
wget -qO- "https://${APIID}.execute-api.us-west-2.amazonaws.com/${STAGE}/scores?role=photographer&limit=2" | more
wget -qO- "https://${APIID}.execute-api.us-west-2.amazonaws.com/${STAGE}/contributions" | more
```